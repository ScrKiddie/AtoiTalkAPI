asyncapi: '3.0.0'
info:
  title: AtoiTalkAPI WebSocket
  version: 1.0.0
  description: |
    Real-time event specifications for AtoiTalk application.
    
    **Connection:**
    Connect to `/ws` endpoint. Authentication is required via Query Parameter `token`.
    Example: `ws://api.atoitalk.com/ws?token=YOUR_JWT_TOKEN`
    
    **Message Structure:**
    All messages inherit from the `BaseEvent` schema, ensuring a consistent envelope structure:
    ```json
    {
      "type": "string",
      "payload": { ... },
      "meta": { ... }
    }
    ```

servers:
  production:
    host: api.atoitalk.com
    protocol: wss
    pathname: /ws
    security:
      - $ref: '#/components/securitySchemes/queryToken'
  local:
    host: localhost:8080
    protocol: ws
    pathname: /ws
    security:
      - $ref: '#/components/securitySchemes/queryToken'

channels:
  chat:
    address: /ws
    messages:
      clientTyping:
        $ref: '#/components/messages/ClientTyping'
      serverMessageNew:
        $ref: '#/components/messages/ServerMessageNew'
      serverMessageUpdate:
        $ref: '#/components/messages/ServerMessageUpdate'
      serverMessageDelete:
        $ref: '#/components/messages/ServerMessageDelete'
      serverChatNew:
        $ref: '#/components/messages/ServerChatNew'
      serverChatRead:
        $ref: '#/components/messages/ServerChatRead'
      serverChatHide:
        $ref: '#/components/messages/ServerChatHide'
      serverChatDelete:
        $ref: '#/components/messages/ServerChatDelete'
      serverUserOnline:
        $ref: '#/components/messages/ServerUserOnline'
      serverUserOffline:
        $ref: '#/components/messages/ServerUserOffline'
      serverUserUpdate:
        $ref: '#/components/messages/ServerUserUpdate'
      serverUserBlock:
        $ref: '#/components/messages/ServerUserBlock'
      serverUserUnblock:
        $ref: '#/components/messages/ServerUserUnblock'
      serverUserBanned:
        $ref: '#/components/messages/ServerUserBanned'
      serverUserUnbanned:
        $ref: '#/components/messages/ServerUserUnbanned'
      serverUserDeleted:
        $ref: '#/components/messages/ServerUserDeleted'
      serverTyping:
        $ref: '#/components/messages/ServerTyping'

operations:
  receiveClientEvents:
    action: receive
    channel:
      $ref: '#/channels/chat'
    messages:
      - $ref: '#/channels/chat/messages/clientTyping'

  sendServerEvents:
    action: send
    channel:
      $ref: '#/channels/chat'
    messages:
      - $ref: '#/channels/chat/messages/serverMessageNew'
      - $ref: '#/channels/chat/messages/serverMessageUpdate'
      - $ref: '#/channels/chat/messages/serverMessageDelete'
      - $ref: '#/channels/chat/messages/serverChatNew'
      - $ref: '#/channels/chat/messages/serverChatRead'
      - $ref: '#/channels/chat/messages/serverChatHide'
      - $ref: '#/channels/chat/messages/serverChatDelete'
      - $ref: '#/channels/chat/messages/serverUserOnline'
      - $ref: '#/channels/chat/messages/serverUserOffline'
      - $ref: '#/channels/chat/messages/serverUserUpdate'
      - $ref: '#/channels/chat/messages/serverUserBlock'
      - $ref: '#/channels/chat/messages/serverUserUnblock'
      - $ref: '#/channels/chat/messages/serverUserBanned'
      - $ref: '#/channels/chat/messages/serverUserUnbanned'
      - $ref: '#/channels/chat/messages/serverUserDeleted'
      - $ref: '#/channels/chat/messages/serverTyping'

components:
  securitySchemes:
    queryToken:
      type: httpApiKey
      name: token
      in: query
      description: JWT Token passed as a query parameter

  schemas:
    EventMeta:
      type: object
      properties:
        timestamp:
          type: integer
          description: Unix timestamp in milliseconds
        chat_id:
          type: string
          format: uuid
          description: ID of the chat context (optional)
        sender_id:
          type: string
          format: uuid
          description: ID of the user who triggered the event
        unread_count:
          type: integer
          description: Current unread count for the receiving user (specific to message.new)
    
    BaseEvent:
      type: object
      required: [type, meta]
      properties:
        type:
          type: string
          description: The unique identifier for the event type.
        meta:
          $ref: '#/components/schemas/EventMeta'
    
    UserDTO:
      type: object
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        full_name:
          type: string
        avatar:
          type: string
          format: uri
        bio:
          type: string
        is_online:
          type: boolean
        last_seen_at:
          type: string
          format: date-time
        is_blocked_by_me:
          type: boolean
        is_blocked_by_other:
          type: boolean

    UserUpdateEventPayload:
      type: object
      description: Payload for user.update event containing only public info
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        full_name:
          type: string
        avatar:
          type: string
          format: uri
        bio:
          type: string
        last_seen_at:
          type: string
          format: date-time
          
    UserPresencePayload:
      type: object
      description: Payload for user.online and user.offline events
      properties:
        user_id:
          type: string
          format: uuid
        is_online:
          type: boolean
        last_seen_at:
          type: integer
          description: Unix timestamp in milliseconds

    MediaDTO:
      type: object
      properties:
        id:
          type: string
          format: uuid
        file_name:
          type: string
        original_name:
          type: string
        file_size:
          type: integer
        mime_type:
          type: string
        url:
          type: string
          format: uri

    ReplyPreviewDTO:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sender_name:
          type: string
        type:
          type: string
          description: Type of the replied message (regular, system_*, etc.)
        content:
          type: string
        action_data:
          type: object
          description: Metadata for system messages
        deleted_at:
          type: string
          format: date-time
          description: If present, the reply message has been deleted.
        is_jumpable:
          type: boolean
          description: Indicates if the original message is accessible to the current user (not hidden/deleted for them).

    MessageResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        chat_id:
          type: string
          format: uuid
        sender_id:
          type: string
          format: uuid
        sender_name:
          type: string
        sender_username:
          type: string
          description: Username of the sender
        sender_avatar:
          type: string
          format: uri
          description: Avatar URL of the sender
        type:
          type: string
          description: Type of the message (regular, system_create, system_add, system_rename, system_description, system_avatar, system_leave, system_promote, system_demote, system_kick, etc.)
        content:
          type: string
        action_data:
          type: object
          description: Metadata for system messages (e.g. target_id, new_name, old_name, new_description, new_role, action)
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/MediaDTO'
          description: List of attachments. Omitted if empty.
        reply_to:
          $ref: '#/components/schemas/ReplyPreviewDTO'
        created_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          description: If present, the message has been deleted.
        edited_at:
          type: string
          format: date-time
          description: If present, the message has been edited.

    ChatListResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [private, group]
        name:
          type: string
        avatar:
          type: string
          format: uri
        last_message:
          $ref: '#/components/schemas/MessageResponse'
          description: Omitted if null (e.g. new chat)
        unread_count:
          type: integer
          description: Omitted if 0
        last_read_at:
          type: string
          format: date-time
          description: Omitted if null
        other_last_read_at:
          type: string
          format: date-time
          description: Omitted if null
        is_online:
          type: boolean
        other_user_id:
          type: string
          format: uuid
          description: Omitted if not applicable (e.g. group chat)
        other_user_is_deleted:
          type: boolean
          description: True if the other user in a private chat has deleted their account.
        other_user_is_banned:
          type: boolean
          description: True if the other user in a private chat has been banned.
        is_blocked_by_me:
          type: boolean
          description: Omitted if false
        my_role:
          type: string
          enum: [owner, admin, member]
          description: Current user's role in the group (Omitted for private chat)
        member_count:
          type: integer
          description: Total number of active members in a group chat.

    GroupMemberDTO:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        username:
          type: string
        full_name:
          type: string
        avatar:
          type: string
          format: uri
        role:
          type: string
          enum: [owner, admin, member]
        joined_at:
          type: string
          format: date-time
        is_online:
          type: boolean

  messages:
    ClientTyping:
      name: chat.typing
      title: User Starts Typing (Client -> Server)
      summary: Sent by client when user starts typing in a chat.
      payload:
        type: object
        properties:
          type:
            const: chat.typing
          meta:
            type: object
            properties:
              chat_id:
                type: string
                format: uuid
                
    ServerTyping:
      name: chat.typing
      title: User is Typing (Server -> Client)
      summary: Broadcasted to other chat members when a user is typing.
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: chat.typing

    ServerMessageNew:
      name: message.new
      title: New Message
      summary: Broadcasted when a new message (regular or system) is received
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: message.new
              payload:
                $ref: '#/components/schemas/MessageResponse'

    ServerMessageUpdate:
      name: message.update
      title: Message Updated
      summary: Broadcasted when a message is edited
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: message.update
              payload:
                $ref: '#/components/schemas/MessageResponse'

    ServerMessageDelete:
      name: message.delete
      title: Message Deleted
      summary: Broadcasted when a message is deleted
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: message.delete
              payload:
                type: object
                properties:
                  message_id:
                    type: string
                    format: uuid

    ServerChatNew:
      name: chat.new
      title: New Chat / Chat Update
      summary: Sent to target user when a new private chat is started, when added to a group, OR when group info (name/avatar) is updated.
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: chat.new
              payload:
                $ref: '#/components/schemas/ChatListResponse'

    ServerChatRead:
      name: chat.read
      title: Chat Read Status
      summary: Broadcasted when a user reads a chat
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: chat.read
              payload:
                type: object
                properties:
                  chat_id:
                    type: string
                    format: uuid
                  user_id:
                    type: string
                    format: uuid
                    description: The user who read the chat

    ServerChatHide:
      name: chat.hide
      title: Chat Hidden
      summary: Sent to the user who hid the chat (for multi-device sync)
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: chat.hide
              payload:
                type: object
                properties:
                  chat_id:
                    type: string
                    format: uuid

    ServerChatDelete:
      name: chat.delete
      title: Chat Deleted
      summary: Sent to all members when a group chat is deleted by the owner.
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: chat.delete
              payload:
                type: object
                properties:
                  chat_id:
                    type: string
                    format: uuid

    ServerUserOnline:
      name: user.online
      title: User Online
      summary: Broadcasted to contacts when a user comes online
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.online
              payload:
                $ref: '#/components/schemas/UserPresencePayload'

    ServerUserOffline:
      name: user.offline
      title: User Offline
      summary: Broadcasted to contacts when a user goes offline
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.offline
              payload:
                $ref: '#/components/schemas/UserPresencePayload'

    ServerUserUpdate:
      name: user.update
      title: User Profile Update
      summary: Broadcasted to contacts when a user updates their profile
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.update
              payload:
                $ref: '#/components/schemas/UserUpdateEventPayload'

    ServerUserBlock:
      name: user.block
      title: User Blocked
      summary: Sent to the blocked user immediately
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.block
              payload:
                type: object
                properties:
                  blocker_id:
                    type: string
                    format: uuid
                  blocked_id:
                    type: string
                    format: uuid

    ServerUserUnblock:
      name: user.unblock
      title: User Unblocked
      summary: Sent to the unblocked user immediately
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.unblock
              payload:
                type: object
                properties:
                  blocker_id:
                    type: string
                    format: uuid
                  blocked_id:
                    type: string
                    format: uuid

    ServerUserBanned:
      name: user.banned
      title: User Banned
      summary: Sent to the banned user and their contacts immediately
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.banned
              payload:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  reason:
                    type: string

    ServerUserUnbanned:
      name: user.unbanned
      title: User Unbanned
      summary: Sent to the unbanned user and their contacts immediately
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.unbanned
              payload:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid

    ServerUserDeleted:
      name: user.deleted
      title: User Deleted
      summary: Sent to contacts when a user deletes their account
      payload:
        allOf:
          - $ref: '#/components/schemas/BaseEvent'
          - type: object
            properties:
              type:
                const: user.deleted
              payload:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
